name: iOS App Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if iOS project exists
        id: check-ios
        run: |
          if [ -d "ios" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        if: steps.check-ios.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.check-ios.outputs.exists == 'true'
        run: |
          if [ -f "package.json" ]; then
            npm ci
          fi

      - name: Install CocoaPods
        if: steps.check-ios.outputs.exists == 'true'
        run: |
          if [ -d "ios" ]; then
            cd ios
            pod install
          fi

      - name: Set up Xcode
        if: steps.check-ios.outputs.exists == 'true'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build iOS App (Debug)
        if: steps.check-ios.outputs.exists == 'true'
        run: |
          if [ -d "ios" ]; then
            cd ios
            WORKSPACE=$(find . -name "*.xcworkspace" | head -1)
            if [ -n "$WORKSPACE" ]; then
              xcodebuild -workspace "$WORKSPACE" \
                -scheme "$(basename "$WORKSPACE" .xcworkspace)" \
                -sdk iphonesimulator \
                -configuration Debug \
                -derivedDataPath build \
                build
            fi
          fi
        continue-on-error: true

      - name: Build iOS App (Release - unsigned)
        if: steps.check-ios.outputs.exists == 'true'
        run: |
          if [ -d "ios" ]; then
            cd ios
            WORKSPACE=$(find . -name "*.xcworkspace" | head -1)
            if [ -n "$WORKSPACE" ]; then
              xcodebuild -workspace "$WORKSPACE" \
                -scheme "$(basename "$WORKSPACE" .xcworkspace)" \
                -sdk iphoneos \
                -configuration Release \
                -derivedDataPath build \
                CODE_SIGN_IDENTITY="" \
                CODE_SIGNING_REQUIRED=NO \
                CODE_SIGNING_ALLOWED=NO \
                build
            fi
          fi
        continue-on-error: true

      - name: Archive build artifacts
        if: steps.check-ios.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            ios/build/Build/Products/Debug-iphonesimulator/*.app
            ios/build/Build/Products/Release-iphoneos/*.app
          if-no-files-found: warn

      - name: Run iOS Tests
        if: steps.check-ios.outputs.exists == 'true'
        run: |
          if [ -d "ios" ]; then
            cd ios
            WORKSPACE=$(find . -name "*.xcworkspace" | head -1)
            if [ -n "$WORKSPACE" ]; then
              xcodebuild test \
                -workspace "$WORKSPACE" \
                -scheme "$(basename "$WORKSPACE" .xcworkspace)" \
                -sdk iphonesimulator \
                -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest'
            fi
          fi
        continue-on-error: true
