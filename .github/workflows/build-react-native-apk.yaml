name: Build React Native Android APK
run-name: ${{ github.event.inputs.repository }} ${{ github.event.inputs.branchName && format('{0}', github.event.inputs.branchName) }} ${{ github.event.inputs.subdir && format('[/{0}]', github.event.inputs.subdir) }}

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "Git repository URL"
        required: true
        default: "https://github.com/facebook/react-native"
      branchName:
        description: "Git branch name [Optional]"
        required: false
        default: ""
      subdir:
        description: "Relative subdirectory path when the project is nested [Optional]"
        required: false
        default: ""
      nodeVersion:
        description: "Node.js version to use (e.g., 18, 20, 22)"
        required: false
        default: "20"
      buildType:
        description: "Build type: debug, release, or both"
        required: false
        default: "release"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clone project
        run: |
          if [[ -z "${{ github.event.inputs.branchName }}" ]]; then
            git clone --recurse-submodules --depth=1 ${{ github.event.inputs.repository }} workspace
          else
            git clone --recurse-submodules --depth=1 --branch ${{ github.event.inputs.branchName }} ${{ github.event.inputs.repository }} workspace
          fi

      - name: Determine React Native project directory
        working-directory: ./workspace
        run: |
          if [[ -n "${{ github.event.inputs.subdir }}" ]]; then
            BUILD_DIR="${{ github.event.inputs.subdir }}"
          else
            # Search for package.json with React Native project (has android dir)
            for dir in $(find . -maxdepth 3 -name "package.json" -exec dirname {} \;); do
              if [ -d "$dir/android" ]; then
                BUILD_DIR="$dir"
                break
              fi
            done

            if [ -z "$BUILD_DIR" ]; then
              echo "Error: Could not find React Native project (package.json + android directory). Please specify the 'subdir' input parameter."
              exit 1
            fi
          fi

          echo "Building in directory: $BUILD_DIR"
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ github.event.inputs.nodeVersion }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        working-directory: ./workspace/${{ env.BUILD_DIR }}
        run: |
          if [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
          elif [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Grant execute permission for gradlew
        working-directory: ./workspace/${{ env.BUILD_DIR }}
        run: chmod +x android/gradlew

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3

      - name: Build Android Debug APK
        if: github.event.inputs.buildType == 'debug' || github.event.inputs.buildType == 'both'
        working-directory: ./workspace/${{ env.BUILD_DIR }}/android
        run: ./gradlew assembleDebug --warning-mode all --stacktrace

      - name: Build Android Release APK
        if: github.event.inputs.buildType == 'release' || github.event.inputs.buildType == 'both'
        working-directory: ./workspace/${{ env.BUILD_DIR }}/android
        run: |
          # Sign with debug key for release builds in CI
          if [ ! -f "$HOME/.android/debug.keystore" ]; then
            echo "Debug keystore not found. Creating one..."
            keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "C=US, O=Android, CN=Android Debug"
            mkdir -p $HOME/.android
            mv debug.keystore $HOME/.android/debug.keystore
          fi

          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file="$HOME/.android/debug.keystore" \
            -Pandroid.injected.signing.store.password=android \
            -Pandroid.injected.signing.key.alias=androiddebugkey \
            -Pandroid.injected.signing.key.password=android \
            --warning-mode all \
            --stacktrace

      - name: Upload APK artifacts with 1 day retention
        uses: actions/upload-artifact@v4
        with:
          path: workspace/**/android/app/build/outputs/apk/**/*.apk
          name: react-native-apk-archive
          retention-days: 1
